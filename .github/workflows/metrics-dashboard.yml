name: Metrics Dashboard

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to analyze'
        required: false
        default: '30'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-metrics:
    name: Generate Metrics Reports
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate metrics

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Make scripts executable
        run: |
          chmod +x metrics/track-ai-impact.sh
          chmod +x metrics/dora-metrics.sh

      - name: Generate AI Impact Metrics
        run: |
          DAYS=${{ github.event.inputs.days || '30' }}
          ./metrics/track-ai-impact.sh $DAYS

      - name: Generate DORA Metrics
        run: |
          DAYS=${{ github.event.inputs.days || '30' }}
          ./metrics/dora-metrics.sh $DAYS

      - name: Create metrics archive
        run: |
          mkdir -p metrics/archive
          cp metrics/*.json metrics/archive/ 2>/dev/null || true
          cp metrics/*.md metrics/archive/ 2>/dev/null || true
          cp metrics/*.csv metrics/archive/ 2>/dev/null || true

      - name: Generate HTML Dashboard
        run: |
          cat > metrics/dashboard.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AI Impact & DORA Metrics Dashboard</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      line-height: 1.6;
                      color: #333;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 20px;
                  }
                  .container {
                      max-width: 1400px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 12px;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                      overflow: hidden;
                  }
                  header {
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      padding: 40px;
                      text-align: center;
                  }
                  h1 {
                      font-size: 2.5em;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      font-size: 1.1em;
                      opacity: 0.9;
                  }
                  .content {
                      padding: 40px;
                  }
                  .metrics-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                      gap: 20px;
                      margin-bottom: 40px;
                  }
                  .metric-card {
                      background: #f8f9fa;
                      border-radius: 8px;
                      padding: 25px;
                      border-left: 4px solid #667eea;
                      transition: transform 0.2s, box-shadow 0.2s;
                  }
                  .metric-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
                  }
                  .metric-card h3 {
                      color: #667eea;
                      margin-bottom: 15px;
                      font-size: 1.2em;
                  }
                  .metric-value {
                      font-size: 2.5em;
                      font-weight: bold;
                      color: #333;
                      margin-bottom: 10px;
                  }
                  .metric-label {
                      color: #666;
                      font-size: 0.9em;
                  }
                  .status-badge {
                      display: inline-block;
                      padding: 5px 15px;
                      border-radius: 20px;
                      font-size: 0.85em;
                      font-weight: bold;
                      margin-top: 10px;
                  }
                  .status-elite {
                      background: #10b981;
                      color: white;
                  }
                  .status-high {
                      background: #3b82f6;
                      color: white;
                  }
                  .status-medium {
                      background: #f59e0b;
                      color: white;
                  }
                  .status-low {
                      background: #ef4444;
                      color: white;
                  }
                  .section {
                      margin-bottom: 40px;
                  }
                  .section h2 {
                      color: #667eea;
                      margin-bottom: 20px;
                      padding-bottom: 10px;
                      border-bottom: 2px solid #e5e7eb;
                  }
                  .report-links {
                      display: flex;
                      gap: 15px;
                      flex-wrap: wrap;
                      margin-top: 20px;
                  }
                  .report-link {
                      display: inline-block;
                      padding: 12px 24px;
                      background: #667eea;
                      color: white;
                      text-decoration: none;
                      border-radius: 6px;
                      font-weight: 500;
                      transition: background 0.2s;
                  }
                  .report-link:hover {
                      background: #764ba2;
                  }
                  footer {
                      background: #f8f9fa;
                      padding: 20px;
                      text-align: center;
                      color: #666;
                      font-size: 0.9em;
                  }
                  .timestamp {
                      color: #999;
                      font-size: 0.85em;
                      margin-top: 10px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <header>
                      <h1>ðŸ“Š Metrics Dashboard</h1>
                      <p class="subtitle">AI Impact & DORA Metrics Tracking</p>
                  </header>

                  <div class="content">
                      <div class="section">
                          <h2>ðŸ¤– AI Impact Metrics</h2>
                          <div class="metrics-grid">
                              <div class="metric-card">
                                  <h3>Total Commits</h3>
                                  <div class="metric-value" id="total-commits">--</div>
                                  <div class="metric-label">Last 30 days</div>
                              </div>
                              <div class="metric-card">
                                  <h3>AI-Assisted Commits</h3>
                                  <div class="metric-value" id="ai-commits">--</div>
                                  <div class="metric-label">Percentage: <span id="ai-percentage">--</span>%</div>
                              </div>
                              <div class="metric-card">
                                  <h3>Time Saved</h3>
                                  <div class="metric-value" id="time-saved">--</div>
                                  <div class="metric-label">Hours</div>
                              </div>
                              <div class="metric-card">
                                  <h3>Commits per Day</h3>
                                  <div class="metric-value" id="commits-per-day">--</div>
                                  <div class="metric-label">Velocity</div>
                              </div>
                          </div>
                      </div>

                      <div class="section">
                          <h2>ðŸš€ DORA Metrics</h2>
                          <div class="metrics-grid">
                              <div class="metric-card">
                                  <h3>Deployment Frequency</h3>
                                  <div class="metric-value" id="deploy-freq">--</div>
                                  <div class="metric-label">per week</div>
                                  <span class="status-badge" id="deploy-status">--</span>
                              </div>
                              <div class="metric-card">
                                  <h3>Lead Time</h3>
                                  <div class="metric-value" id="lead-time">--</div>
                                  <div class="metric-label">days</div>
                                  <span class="status-badge" id="lead-status">--</span>
                              </div>
                              <div class="metric-card">
                                  <h3>Change Failure Rate</h3>
                                  <div class="metric-value" id="failure-rate">--</div>
                                  <div class="metric-label">percent</div>
                                  <span class="status-badge" id="failure-status">--</span>
                              </div>
                              <div class="metric-card">
                                  <h3>Time to Restore</h3>
                                  <div class="metric-value" id="mttr">--</div>
                                  <div class="metric-label">hours</div>
                                  <span class="status-badge" id="mttr-status">--</span>
                              </div>
                          </div>
                      </div>

                      <div class="section">
                          <h2>ðŸ“„ Detailed Reports</h2>
                          <div class="report-links">
                              <a href="#" class="report-link" id="ai-json-link">AI Metrics (JSON)</a>
                              <a href="#" class="report-link" id="ai-csv-link">AI Metrics (CSV)</a>
                              <a href="#" class="report-link" id="dora-json-link">DORA Metrics (JSON)</a>
                              <a href="#" class="report-link" id="dora-md-link">DORA Report (Markdown)</a>
                          </div>
                          <div class="timestamp" id="generated-time">Generated: --</div>
                      </div>
                  </div>

                  <footer>
                      <p>Metrics automatically generated by GitHub Actions</p>
                      <p>Learn more: <a href="../docs/ai-impact-framework.md">AI Impact Framework</a> | <a href="../docs/dora-metrics-guide.md">DORA Metrics Guide</a></p>
                  </footer>
              </div>

              <script>
                  // Load metrics from JSON files
                  async function loadMetrics() {
                      try {
                          // Load AI Impact metrics
                          const aiFiles = await fetch('./').then(r => r.text());
                          const aiJsonMatch = aiFiles.match(/ai-impact-\d+_\d+\.json/);
                          if (aiJsonMatch) {
                              const aiData = await fetch('./' + aiJsonMatch[0]).then(r => r.json());
                              document.getElementById('total-commits').textContent = aiData.summary.total_commits;
                              document.getElementById('ai-commits').textContent = aiData.summary.ai_assisted_commits;
                              document.getElementById('ai-percentage').textContent = aiData.summary.ai_commit_percentage;
                              document.getElementById('time-saved').textContent = aiData.summary.total_time_saved_hours;
                              document.getElementById('commits-per-day').textContent = aiData.velocity.commits_per_day;
                              document.getElementById('generated-time').textContent = 'Generated: ' + aiData.report_metadata.generated_at;
                          }

                          // Load DORA metrics
                          const doraJsonMatch = aiFiles.match(/dora-metrics-\d+_\d+\.json/);
                          if (doraJsonMatch) {
                              const doraData = await fetch('./' + doraJsonMatch[0]).then(r => r.json());
                              const dora = doraData.dora_metrics;

                              document.getElementById('deploy-freq').textContent = dora.deployment_frequency.per_week;
                              document.getElementById('lead-time').textContent = dora.lead_time_for_changes.average_days;
                              document.getElementById('failure-rate').textContent = dora.change_failure_rate.failure_rate_percentage + '%';
                              document.getElementById('mttr').textContent = dora.mean_time_to_restore.average_hours;

                              // Status badges
                              const statusMap = {
                                  'Elite': 'status-elite',
                                  'High': 'status-high',
                                  'Medium': 'status-medium',
                                  'Low': 'status-low'
                              };

                              const deployStatus = document.getElementById('deploy-status');
                              deployStatus.textContent = dora.deployment_frequency.performance_level;
                              deployStatus.className = 'status-badge ' + statusMap[dora.deployment_frequency.performance_level];

                              const leadStatus = document.getElementById('lead-status');
                              leadStatus.textContent = dora.lead_time_for_changes.performance_level;
                              leadStatus.className = 'status-badge ' + statusMap[dora.lead_time_for_changes.performance_level];

                              const failureStatus = document.getElementById('failure-status');
                              failureStatus.textContent = dora.change_failure_rate.performance_level;
                              failureStatus.className = 'status-badge ' + statusMap[dora.change_failure_rate.performance_level];

                              const mttrStatus = document.getElementById('mttr-status');
                              mttrStatus.textContent = dora.mean_time_to_restore.performance_level;
                              mttrStatus.className = 'status-badge ' + statusMap[dora.mean_time_to_restore.performance_level];
                          }

                          // Update report links
                          if (aiJsonMatch) {
                              document.getElementById('ai-json-link').href = './' + aiJsonMatch[0];
                          }
                          const aiCsvMatch = aiFiles.match(/ai-impact-\d+_\d+\.csv/);
                          if (aiCsvMatch) {
                              document.getElementById('ai-csv-link').href = './' + aiCsvMatch[0];
                          }
                          if (doraJsonMatch) {
                              document.getElementById('dora-json-link').href = './' + doraJsonMatch[0];
                          }
                          const doraMdMatch = aiFiles.match(/dora-report-\d+_\d+\.md/);
                          if (doraMdMatch) {
                              document.getElementById('dora-md-link').href = './' + doraMdMatch[0];
                          }
                      } catch (error) {
                          console.error('Error loading metrics:', error);
                      }
                  }

                  loadMetrics();
              </script>
          </body>
          </html>
          EOF

      - name: Upload Metrics Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: metrics-report-${{ github.run_number }}
          path: |
            metrics/*.json
            metrics/*.csv
            metrics/*.md
            metrics/dashboard.html
          retention-days: 90

      - name: Commit Metrics to Repository
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add metrics/*.json metrics/*.csv metrics/*.md metrics/dashboard.html 2>/dev/null || true
          git diff --staged --quiet || git commit -m "chore: update metrics reports [skip ci]

          AI Generated: 0%
          Time Saved: 0
          Tools Used: None

          Type: chore
          Deployment: no

          Co-Authored-By: GitHub Actions <actions@github.com>"
          git push || echo "No changes to commit"

      - name: Create Summary Report
        run: |
          echo "## ðŸ“Š Metrics Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Period:** Last ${{ github.event.inputs.days || '30' }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f metrics/ai-impact-*.json ]; then
            echo "### ðŸ¤– AI Impact Metrics" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat metrics/ai-impact-*.json | jq '.summary' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f metrics/dora-metrics-*.json ]; then
            echo "### ðŸš€ DORA Metrics" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat metrics/dora-metrics-*.json | jq '.overall_performance' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Slack Notification (Optional)
        if: false  # Enable by setting to 'true' and adding SLACK_WEBHOOK secret
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "ðŸ“Š Weekly Metrics Report Generated",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Weekly Metrics Report*\nView the latest AI Impact and DORA metrics in the repository."
                  }
                }
              ]
            }'

  # Optional: Deploy to GitHub Pages
  deploy-pages:
    name: Deploy Dashboard to GitHub Pages
    runs-on: ubuntu-latest
    needs: generate-metrics
    if: false  # Enable by setting to 'true' and enabling GitHub Pages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download metrics
        uses: actions/download-artifact@v4
        with:
          name: metrics-report-${{ github.run_number }}
          path: ./public

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './public'

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
